- name: deploy_client
  hosts: localhost
  gather_facts: no
  vars_files:
    - vars.yml

  vars:
    ansible_python_interpreter: /opt/deployment_api/venv/bin/python
    proxmox_username: "{{ proxmox_user.split('@')[0] }}"
    proxmox_realm: "{{ proxmox_user.split('@')[1] }}"

  tasks:
    - name: Load deployment variables
      import_tasks: tasks/set_fact.yml
      
    - name: Authenticate with Proxmox
      uri:
        url: "https://{{ proxmox_ip }}:8006/api2/json/access/ticket"
        method: POST
        body_format: form-urlencoded
        body:
          username: "{{ proxmox_username }}"
          password: "{{ proxmox_password }}"
          realm: "{{ proxmox_realm }}"
        validate_certs: false
        status_code: 200
      register: auth_response
      no_log: true

    # Debug authentication response
    - name: Debug authentication
      debug:
        msg: "Successfully authenticated with Proxmox. Got ticket and CSRF token."
      when: auth_response.status == 200
        
    - name: Setup SDN infrastructure
      import_tasks: tasks/setup_sdn.yml