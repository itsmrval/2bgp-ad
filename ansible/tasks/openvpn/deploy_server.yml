---
- name: install_openvpn
  apk:
    name: openvpn
    update_cache: yes

- name: deploy_easyrsa
  copy:
    src: /usr/share/easy-rsa/
    dest: /etc/openvpn/easy-rsa
    remote_src: yes

- name: init_pki
  command: /etc/openvpn/easy-rsa/easyrsa init-pki
  args:
    chdir: /etc/openvpn/easy-rsa

- name: init_env
  lineinfile:
    path: /etc/openvpn/easy-rsa/vars
    line: "{{ item }}"
  loop:
    - "set_var EASYRSA_REQ_COUNTRY    \"US\""
    - "set_var EASYRSA_REQ_PROVINCE   \"California\""
    - "set_var EASYRSA_REQ_CITY       \"San Francisco\""
    - "set_var EASYRSA_REQ_ORG        \"MyOrg\""
    - "set_var EASYRSA_REQ_EMAIL      \"email@example.com\""
    - "set_var EASYRSA_REQ_OU         \"MyOrgUnit\""

- name: build_ca
  command: /etc/openvpn/easy-rsa/easyrsa build-ca nopass
  args:
    chdir: /etc/openvpn/easy-rsa
  environment:
    EASYRSA_BATCH: "1"

- name: generate_srv_cert
  command: /etc/openvpn/easy-rsa/easyrsa gen-req server nopass
  args:
    chdir: /etc/openvpn/easy-rsa
  environment:
    EASYRSA_BATCH: "1"

- name: sign_srv_cert
  command: /etc/openvpn/easy-rsa/easyrsa sign-req server server
  args:
    chdir: /etc/openvpn/easy-rsa
  environment:
    EASYRSA_BATCH: "1"

- name: gen_dh
  command: /etc/openvpn/easy-rsa/easyrsa gen-dh
  args:
    chdir: /etc/openvpn/easy-rsa

- name: gen_ta
  command: openvpn --genkey --secret ta.key
  args:
    chdir: /etc/openvpn/easy-rsa

- name: create_openvpn_dir
  file:
    path: /etc/openvpn
    state: directory

- name: copy_openvpn_keys
  copy:
    src: "{{ item }}"
    dest: /etc/openvpn
    remote_src: yes
  loop:
    - /etc/openvpn/easy-rsa/pki/ca.crt
    - /etc/openvpn/easy-rsa/pki/issued/server.crt
    - /etc/openvpn/easy-rsa/pki/private/server.key
    - /etc/openvpn/easy-rsa/pki/dh.pem
    - /etc/openvpn/easy-rsa/ta.key

- name: create_openvpn_conf
  copy:
    content: |
      port 1194
      proto udp
      dev tun
      ca ca.crt
      cert server.crt
      key server.key
      dh dh.pem
      tls-auth ta.key 0
      server 10.8.0.0 255.255.255.0
      ifconfig-pool-persist ipp.txt
      push "redirect-gateway def1 bypass-dhcp"
      push "dhcp-option DNS 8.8.8.8"
      keepalive 10 120
      cipher AES-256-CBC
      user nobody
      group nogroup
      persist-key
      persist-tun
      status openvpn-status.log
      verb 3
      client-config-dir /etc/openvpn/ccd
    dest: /etc/openvpn/server.conf

- name: create_openvpn_ccd
  file:
    path: /etc/openvpn/ccd
    state: directory

- name: start_openvpn
  service:
    name: openvpn
    enabled: yes
    state: started
