---
- name: Install and Configure Pritunl, OpenVPN, and MongoDB
  hosts: localhost
  become: yes

  tasks:

    - name: Install curl
      apt:
        name:
          - curl
        state: present
        
    - name: Add MongoDB repository
      copy:
        dest: /etc/apt/sources.list.d/mongodb-org.list
        content: |
          deb [ signed-by=/usr/share/keyrings/mongodb-server-8.0.gpg ] https://repo.mongodb.org/apt/ubuntu noble/mongodb-org/8.0 multiverse

    - name: Add OpenVPN repository
      copy:
        dest: /etc/apt/sources.list.d/openvpn.list
        content: |
          deb [ signed-by=/usr/share/keyrings/openvpn-repo.gpg ] https://build.openvpn.net/debian/openvpn/stable noble main

    - name: Add Pritunl repository
      copy:
        dest: /etc/apt/sources.list.d/pritunl.list
        content: |
          deb [ signed-by=/usr/share/keyrings/pritunl.gpg ] https://repo.pritunl.com/stable/apt noble main

    - name: Install gnupg
      apt:
        name: gnupg
        state: present

    - name: Add MongoDB GPG key
      shell: curl -fsSL https://www.mongodb.org/static/pgp/server-8.0.asc | gpg -o /usr/share/keyrings/mongodb-server-8.0.gpg --dearmor --yes

    - name: Add OpenVPN GPG key
      shell: curl -fsSL https://swupdate.openvpn.net/repos/repo-public.gpg | gpg -o /usr/share/keyrings/openvpn-repo.gpg --dearmor --yes

    - name: Add Pritunl GPG key
      shell: curl -fsSL https://raw.githubusercontent.com/pritunl/pgp/master/pritunl_repo_pub.asc | gpg -o /usr/share/keyrings/pritunl.gpg --dearmor --yes

    - name: Update apt cache
      apt:
        update_cache: yes

    - name: Install required packages
      apt:
        name:
          - pritunl
          - openvpn
          - mongodb-org
          - wireguard
          - wireguard-tools
        state: present

    - name: Disable UFW
      command: ufw disable
      ignore_errors: yes

    - name: Start and enable Pritunl service
      systemd:
        name: pritunl
        state: started
        enabled: yes

    - name: Start and enable MongoDB service
      systemd:
        name: mongod
        state: started
        enabled: yes
